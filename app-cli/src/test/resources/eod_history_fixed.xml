<?xml version="1.0" encoding="UTF-8" ?>
<story id="eod-history-fixed">

    <archives>
        <Archive id="DataStore" base="/Users/ldaniels/broadway/archive" compression="gzip" />
    </archives>

    <triggers>
        <FileTrigger id="Repo1">
            <directory path="/Users/ldaniels/broadway/incoming/tradingHistory" archive="DataStore">
                <feed pattern="AMEX_(.*)[.]txt">
                    <BasicFlow input-source="input_file" output-source="output_file" />
                </feed>
                <feed pattern="NASDAQ_(.*)[.]txt">
                    <BasicFlow input-source="input_file" output-source="output_file" />
                </feed>
                <feed pattern="NYSE_(.*)[.]txt">
                    <BasicFlow input-source="input_file" output-source="output_file" />
                </feed>
                <feed pattern="OTCBB_(.*)[.]txt">
                    <BasicFlow input-source="input_file" output-source="output_file" />
                </feed>
            </directory>
        </FileTrigger>
    </triggers>

    <data-sources>
        <TextFileInputSource id="input_file" path="{{ flow.input.path }}" />
        <TextFileOutputSource id="output_file" path="/tmp/fixed_{{ flow.input.filename }}" />
    </data-sources>

    <layouts>
        <TextLayout id="input_layout">
            <header>
                <record type="csv">
                    <field auto-trim="yes">&lt;ticker&gt;</field>
                    <field auto-trim="yes">&lt;date&gt;</field>
                    <field auto-trim="yes">&lt;open&gt;</field>
                    <field auto-trim="yes">&lt;high&gt;</field>
                    <field auto-trim="yes">&lt;low&gt;</field>
                    <field auto-trim="yes">&lt;close&gt;</field>
                    <field auto-trim="yes">&lt;vol&gt;</field>
                </record>
            </header>
            <body>
                <record type="csv">
                    <field auto-trim="yes">ticker</field>
                    <field auto-trim="yes">date</field>
                    <field auto-trim="yes">open</field>
                    <field auto-trim="yes">high</field>
                    <field auto-trim="yes">low</field>
                    <field auto-trim="yes">close</field>
                    <field auto-trim="yes">vol</field>
                </record>
            </body>
        </TextLayout>

        <TextLayout id="output_layout">
            <header>
                <record type="fixed-length">
                    <field length="10">symbol</field>
                    <field length="9">date</field>
                    <field length="12">open</field>
                    <field length="12">high</field>
                    <field length="12">low</field>
                    <field length="12">close</field>
                    <field length="12">volume</field>
                </record>
            </header>
            <body>
                <record type="fixed-length">
                    <field length="10">ticker</field>
                    <field length="9">date</field>
                    <field length="12">open</field>
                    <field length="12">high</field>
                    <field length="12">low</field>
                    <field length="12">close</field>
                    <field length="12">vol</field>
                </record>
            </body>
            <footer>
                <record type="fixed-length">
                    <field length="30">{{ flow.input.filename }}</field>
                    <field length="10">{{ flow.input.count }}</field>
                </record>
                <record type="fixed-length">
                    <field length="30">{{ flow.output.filename }}</field>
                    <field length="10">{{ flow.output.count }}</field>
                </record>
            </footer>
        </TextLayout>
    </layouts>
</story>