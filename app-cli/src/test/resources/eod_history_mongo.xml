<?xml version="1.0" encoding="UTF-8" ?>
<story id="eod-history-mongo">

    <archives>
        <FileArchive id="DataStore" base="/Users/ldaniels/broadway/archive" compression="gzip" />
    </archives>

    <triggers>
        <FileTrigger id="Repo1">
            <directory path="/Users/ldaniels/broadway/incoming/tradingHistory" archive="DataStore">
                <feed pattern="AMEX_(.*)[.]txt">
                    <BasicFlow input-source="input_file" output-source="mongo_db" />
                </feed>
                <feed pattern="NASDAQ_(.*)[.]txt">
                    <BasicFlow input-source="input_file" output-source="mongo_db" />
                </feed>
                <feed pattern="NYSE_(.*)[.]txt">
                    <BasicFlow input-source="input_file" output-source="mongo_db" />
                </feed>
                <feed pattern="OTCBB_(.*)[.]txt">
                    <BasicFlow input-source="input_file" output-source="mongo_db" />
                </feed>
            </directory>
        </FileTrigger>
    </triggers>

    <data-sources>
        <TextFileInputSource id="input_file" path="{{ flow.input.path }}" layout="input_layout" />
        <MongoOutputSource id="mongo_db" servers="localhost" database="shocktrade" collection="test_history" layout="mongo_output"/>
    </data-sources>

    <layouts>
        <TextLayout id="input_layout">
            <header>
                <record type="csv">
                    <field name="ticker" value="&lt;ticker&gt;" type="string" />
                    <field name="date" value="&lt;date&gt;" type="string" />
                    <field name="open" value="&lt;open&gt;" type="string" />
                    <field name="high" value="&lt;high&gt;" type="string" />
                    <field name="low" value="&lt;low&gt;" type="string" />
                    <field name="close" value="&lt;close&gt;" type="string" />
                    <field name="volume" value="&lt;vol&gt;" type="string" />
                </record>
            </header>
            <body>
                <record type="csv">
                    <field name="ticker" type="string" />
                    <field name="date" type="string" />
                    <field name="open" type="string" />
                    <field name="high" type="string" />
                    <field name="low" type="string" />
                    <field name="close" type="string" />
                    <field name="volume" type="string" />
                </record>
            </body>
        </TextLayout>

        <JsonLayout id="mongo_output">
            <record type="json">
                <field name="ticker" type="string" value="{{ input_layout.body.ticker }}"/>
                <field name="date" type="string" value="{{ input_layout.body.date }}"/>
                <field name="open" type="double" value="{{ input_layout.body.open }}"/>
                <field name="high" type="double" value="{{ input_layout.body.high }}"/>
                <field name="low" type="double" value="{{ input_layout.body.low }}"/>
                <field name="close" type="string" value="{{ input_layout.body.close }}"/>
                <field name="volume" type="long" value="{{ input_layout.body.volume }}"/>
            </record>
        </JsonLayout>
    </layouts>
</story>